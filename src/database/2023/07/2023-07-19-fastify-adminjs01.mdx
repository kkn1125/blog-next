---
slug: "/fastify-adminjs01/"
date: 2023-07-19 10:39:05 +0000
modified: 2023-07-19 16:44:24 +0000
title: "[AdminJS] Fastify + AdminJS í”„ë¡œì íŠ¸ í™˜ê²½ êµ¬ì¶• 01"
author: Kimson
categories: [fastify]
image: /assets/images/post/covers/TIL-fastify-adminjs.png
tags: [node, fastify, adminjs, build, til]
description: "Fastifyì™€ AdminJS í”„ë¡œì íŠ¸ í™˜ê²½

ì•ˆë…•í•˜ì„¸ìš”. ì´ë²ˆì—ëŠ” Fastifyì™€ AdminJSë¥¼ ì—°ë™í•˜ëŠ” ë°©ë²•ê³¼ ê²ªì—ˆë˜ ì´ìŠˆë¥¼ ì •ë¦¬í•˜ëŠ” í¬ìŠ¤íŒ…ì´ ë˜ê² ìŠµë‹ˆë‹¤. ì£¼ìš”í•˜ê²Œ ë‹¤ë£° ë¶€ë¶„ì€ í”„ë¡œì íŠ¸ í™˜ê²½ ì„¤ì •ê³¼ ì´ìŠˆ í•´ê²°/ì ìš©ì— ëŒ€í•œ ë°©ë²•ê³¼ ê³¼ì •ì…ë‹ˆë‹¤.

AdminJSëŠ” ë¬´ì—‡ì¸ê°€

AdminJSëŠ” AdminBroì˜ rebrandëœ ëª¨ë“ˆì…ë‹ˆë‹¤. ì´ˆê¸° AdminBroëŠ” fastifyë¥¼ ì§€ì›í•˜ì§€ ì•Šì•˜ê³ , í˜„ì¬ AdminJSë¡œ rebrandë˜ë©´ì„œ fastifyì™€ ì»¤ë®¤ë‹ˆí‹° í”ŒëŸ¬ê·¸ì¸ ë“±ì„ ì§€ì›í•˜ë©°, ESMë§Œì„ ì§€ì›í•˜ëŠ” ëª¨ë“ˆë¡œ ì ì  ë°œì „í•´ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤. ì°¸ê³ ë¡œ AdminBroì™€ AdminJSëŠ” ëª¨ë‘ SoftWareBrothers ê·¸ë£¹ì—ì„œ ì œì‘í–ˆìŠµë‹ˆë‹¤."
featured: true
rating: 4.5
profile: false
published: true
---

# Fastifyì™€ AdminJS í”„ë¡œì íŠ¸ í™˜ê²½

ì•ˆë…•í•˜ì„¸ìš”. ì´ë²ˆì—ëŠ” Fastifyì™€ AdminJSë¥¼ ì—°ë™í•˜ëŠ” ë°©ë²•ê³¼ ê²ªì—ˆë˜ ì´ìŠˆë¥¼ ì •ë¦¬í•˜ëŠ” í¬ìŠ¤íŒ…ì´ ë˜ê² ìŠµë‹ˆë‹¤. ì£¼ìš”í•˜ê²Œ ë‹¤ë£° ë¶€ë¶„ì€ í”„ë¡œì íŠ¸ í™˜ê²½ ì„¤ì •ê³¼ ì´ìŠˆ í•´ê²°/ì ìš©ì— ëŒ€í•œ ë°©ë²•ê³¼ ê³¼ì •ì…ë‹ˆë‹¤.

## AdminJSëŠ” ë¬´ì—‡ì¸ê°€

AdminJSëŠ” AdminBroì˜ rebrandëœ ëª¨ë“ˆì…ë‹ˆë‹¤. ì´ˆê¸° AdminBroëŠ” fastifyë¥¼ ì§€ì›í•˜ì§€ ì•Šì•˜ê³ , í˜„ì¬ AdminJSë¡œ rebrandë˜ë©´ì„œ fastifyì™€ ì»¤ë®¤ë‹ˆí‹° í”ŒëŸ¬ê·¸ì¸ ë“±ì„ ì§€ì›í•˜ë©°, ESMë§Œì„ ì§€ì›í•˜ëŠ” ëª¨ë“ˆë¡œ ì ì  ë°œì „í•´ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤. ì°¸ê³ ë¡œ AdminBroì™€ AdminJSëŠ” ëª¨ë‘ SoftWareBrothers ê·¸ë£¹ì—ì„œ ì œì‘í–ˆìŠµë‹ˆë‹¤.

ë¨¼ì € adminjsì˜ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°„ë‹¨í•˜ê²Œ ì§šê³  ë„˜ì–´ê°€ê³ ì í•˜ëŠ”ë°ìš”. ê²°êµ­ ë§ˆì£¼í•˜ëŠ” ì—ëŸ¬ê°€ ë„ˆë¬´ ë§ì•„ì„œ ëª¨ë“ˆì„ í•˜ë‚˜ ì”© ê¹Œë³´ì•˜ìŠµë‹ˆë‹¤.

1. adminjsëŠ” knexë¥¼ ê¸°ë°˜ìœ¼ë¡œ DBë¥¼ ì œì–´í•œë‹¤.
2. adminjsëŠ” í¬ê²Œ controller, decorator, actionâ€¦ ë“±ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ìˆë‹¤
3. ì´ˆê¸°ì—ëŠ” @adminjs/fastifyì—ì„œ buildRouterí•˜ê²Œ ë˜ë©´ multipartë¥¼ ë“±ë¡í•œë‹¤.
4. adminjs ì—°ê²° í›„ íŒ¨ë„ì—ì„œ ìƒì„±, ìˆ˜ì •ì„ í•˜ê²Œ ë˜ë©´ @adminjs/fastifyë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•´ì„œ @adminjs/sqlëª¨ë“ˆì—ì„œ ë°›ì•„ ë°ì´í„°ë¥¼ ê°€ê³µ, ì‚¬ìš©í•œë‹¤.
5. multipartë¬¸ì œê°€ ë°œìƒí•˜ë©´ ì •ìƒ ì—°ê²°ë˜ë”ë¼ë„ ë°ì´í„° ìƒì„±, ìˆ˜ì •ì´ ì‘ë™í•˜ì§€ ì•Šê³ , ì½ì–´ì˜¤ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì€ ì •ìƒì‘ë™í•œë‹¤.

1~4ë²ˆê¹Œì§€ëŠ” adminjsê°€ ì–´ë–¤ ìˆœì„œë¡œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ”ì§€ë¥¼ ìš”ì•½í•œ ê²ƒì´ê³ , 5ë²ˆì€ ì—°ê²° ì´ìŠˆì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤.

## í”„ë¡œì íŠ¸ í™˜ê²½

fastifyì™€ adminjsë¥¼ ì—°ê²°í•˜ëŠ” ì´ìœ ëŠ” ë‹¹ì—°í•˜ê²Œë„ ê´€ë¦¬ì í˜ì´ì§€ê°€ í•„ìš”í•´ì„œ ì…ë‹ˆë‹¤. ì§ì ‘ ë§Œë“œëŠ”ë° ì‹œê°„ê³¼ ë¹„ìš©ì´ ë“¤ê¸° ë•Œë¬¸ì— ìë™í™” ëœ, ì˜ ë§Œë“¤ì–´ì§„ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ êµ¬ì¶•í•˜ë ¤ í•˜ëŠ”ë° ìƒê°ëŒ€ë¡œ ë˜ì§€ ì•Šì•„ ì• ë¥¼ ë§ì´ ë¨¹ì—ˆìŠµë‹ˆë‹¤. adminjs ì—ëŸ¬ ë•Œë¬¸ì— ê²°êµ­ ì´ì „ í”„ë¡œì íŠ¸ ë•ŒëŠ” ì§ì ‘ êµ¬ì¶•í•´ì•¼ í–ˆëŠ”ë°ìš”. ì´ë²ˆì— ëª‡ ê°€ì§€ ì´ìŠˆë“¤ì„ í•´ê²°í•˜ë©´ì„œ í¬ìŠ¤íŒ…ì„ í•˜ê²Œ ë˜ì—ˆì§€ìš”.

í•„ìê°€ ì œì‘í•˜ëŠ” í”„ë¡œì íŠ¸ì˜ í™˜ê²½ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- fastify
- @adminjs/sql
- @adminjs/fastify
- adminjs
- node 18.11.0
- mysql2 (ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” DBëŠ” MariaDBì…ë‹ˆë‹¤. mysql2ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª…ì…ë‹ˆë‹¤)
- typescript

### typescript

í”„ë¡œì íŠ¸ë¥¼ êµ¬ì„±í•  ë•Œì— ë””ë²„ê¹…ê³¼ í™•ì¥ì„±ì„ ê³ ë ¤í•´ì„œ typescriptë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì •í™•ì„±ê³¼ ì£¼ì„ì„ ì¤„ì´ëŠ”ë°ë„ ë„ì›€ì´ ëœë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤. fastifyë¥¼ typescriptë¡œ ì œì‘í•˜ê³  adminjsì™€ ì—°ê²°í•˜ëŠ”ë° ì¤‘ìš”í•œ ë¶€ë¶„ì´ tsconfigë¼ê³  ìƒê°ë©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë§ì€ ì´ìŠˆê°€ ìˆì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```json highlight={8,31-36} showLineNumbers
{
  "compilerOptions": {
    "rootDir": "./",
    "outDir": "./dist",
    "target": "ESNext",
    "types": ["jest", "node"],
    "lib": ["DOM", "ES7", "ESNext"],
    "module": "CommonJS",
    // "moduleResolution": "Node",
    // "resolveJsonModule": true,
    "useDefineForClassFields": true,
    "allowSyntheticDefaultImports": true,
    "allowJs": true,
    "declaration": true,
    "noImplicitAny": false,
    // "noEmit": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    // "noImplicitAny": true,
    // "strictNullChecks": true,
    "skipLibCheck": true,
    /* fastify typeorm settings */
    "strictPropertyInitialization": false,
    "experimentalDecorators": true,
    // "typeRoots": ["./node_modules/@types"],
    "emitDecoratorMetadata": true,
    "composite": true
  },
  "ts-node": {
    "esm": true,
    "compilerOptions": {
      "module": "NodeNext"
    }
  },
  "include": ["src/**/*"],
  "exclude": ["**/node_modules/*", "build"]
  // "extends": "@tsconfig/node18/tsconfig.json"
}
```

ìœ„ì˜ ì½”ë“œëŠ” ì´ë²ˆ í”„ë¡œì íŠ¸ì— ì„¤ì •í•œ `tsconfig.json` ë‚´ìš©ì…ë‹ˆë‹¤. í˜¹ì‹œë‚˜ adminjsë¥¼ ì—°ê²°í•˜ëŠ”ë° ì• ë¥¼ ë¨¹ê³  ìˆë‹¤ë©´ ì¡°ê¸ˆì´ë‚˜ë§ˆ ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ í•©ë‹ˆë‹¤.

### undefined toLowerCase ë¬¸ì œ

dbëŠ” mariadbë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë•Œë¬¸ì— adminjsì˜ í”ŒëŸ¬ê·¸ì¸ ì¤‘ì— @adminjs/sqlì„ ì‚¬ìš©í•˜ëŠ”ë°ìš”, mysqlì´ë‚˜ postgresqlì€ ìƒê´€ ì—†ì„ ìˆ˜ ìˆì§€ë§Œ, mariadbì˜ ê²½ìš° ì¡°ê¸ˆ íŠ¹ìˆ˜í•´ì„œ ëª¨ë“ˆì˜ ë‚´ìš© ë³€ê²½ì´ ë¶ˆê°€í”¼í–ˆìŠµë‹ˆë‹¤. ê°€ê¸‰ì  ëª¨ë“ˆì„ ê±´ë“œë¦¬ì§€ ì•ŠëŠ” í¸ì´ ìœ ì§€ë³´ìˆ˜ì— ì¢‹ì§€ë§Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì–´ì©” ìˆ˜ ì—†ì—ˆì§€ìš”.

ì´ìœ ë¥¼ ì„¤ëª…í•˜ê¸° ì „ì— sql í”ŒëŸ¬ê·¸ì¸ì— ëŒ€í•´ ì¡°ê¸ˆ ì•Œì•„ë³¼ í•„ìš”ê°€ ìˆëŠ”ë°ìš”. sql í”ŒëŸ¬ê·¸ì¸ì€ knexë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. knexê°€ ì§€ì›í•˜ëŠ” db íƒ€ì…ì€ mysql, mysql2, postgres ì„¸ ê°€ì§€ ì…ë‹ˆë‹¤. ë•Œë¬¸ì— sql í”ŒëŸ¬ê·¸ì¸ ë˜í•œ ì„¸ ê°€ì§€ë¡œ ë™ì¼í•˜ê²Œ íƒ€ì… ì§€ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ì œ ì´ìœ ë¥¼ ë§ì”€ë“œë¦¬ìë©´, knexì—ì„œ mariadbë¥¼ ì—°ê²°í•˜ê³  ë°›ì•„ì˜¤ëŠ” ë°ì´í„°ì˜ í”„ë¡œí¼í‹°ê°€ ì†Œë¬¸ìë¡œ ë°›ì•„ì˜¤ê²Œ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ sql í”ŒëŸ¬ê·¸ì¸ì—ì„œëŠ” ëŒ€ë¬¸ì í”„ë¡œí¼í‹°ë¡œ ì²˜ë¦¬í•˜ê²Œ ë˜ë©´ì„œ toLowerCase() ë©”ì„œë“œê°€ undefinedì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ì—ëŸ¬ë¥¼ ë‚´ë±‰ê²Œ ë©ë‹ˆë‹¤.

```bash showLineNumbers
(node:17912) ExperimentalWarning: Importing JSON modules is an experimental feature. This feature could change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
TypeError: Cannot read properties of undefined (reading 'toLowerCase')
    at getColumnInfo (file:///C:/fake_path/node_modules/@adminjs/sql/src/dialects/mysql.parser.ts:13:33)
    at file:///C:/fake_path/node_modules/@adminjs/sql/src/dialects/mysql.parser.ts:199:46
    at Array.map (<anonymous>)
    at MysqlParser.getProperties (file:///C:/fake_path/node_modules/@adminjs/sql/src/dialects/mysql.parser.ts:199:20)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///C:/fake_path/node_modules/@adminjs/sql/src/dialects/mysql.parser.ts:157:13
    at async Promise.all (index 0)
    at async MysqlParser.getResources (file:///C:/fake_path/node_modules/@adminjs/sql/src/dialects/mysql.parser.ts:148:23)
    at async MysqlParser.parse (file:///C:/fake_path/node_modules/@adminjs/sql/src/dialects/mysql.parser.ts:111:23)
    at async start (file:///C:/fake_path/admin/src/admin.ts:11:14)
```

sql í”ŒëŸ¬ê·¸ì¸ì„ ê¹Œë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```typescript showLineNumbers
// ì˜ˆì‹œ mysql ë°ì´í„°
const dbData = {
  DATA_TYPE: '...',
  DATA_VALUE: '...',
  // ...
}

// ì˜ˆì‹œ mariadb ë°ì´í„°
const dbData = {
  data_type: '...',
  data_value: '...',
  // ...
}

// undefined ì—ëŸ¬ ë°œìƒ ë¶€ë¶„ sql í”ŒëŸ¬ê·¸ì¸ ë¶€ë¶„
const getColumnInfo = (column) => {
    const type = column.DATA_TYPE.toLowerCase(); // ì—¬ê¸°
    const columnType = column.COLUMN_TYPE.toLowerCase();
    let availableValues = null;
    if (type === 'set' || type === 'enum') {
        if (!columnType.startsWith(type)) {
            throw new Error(`Unknown column type: ${type}`);
        }
        availableValues = columnType
            .split(type)[1]
            .replace(/^\('/, '')
            .replace(/'\)$/, '')
            .split('\',\'');
    }
    const reference = column.REFERENCED_TABLE_NAME;
    const isId = column.COLUMN_KEY.toLowerCase() === 'pri';
    const isNullable = column.IS_NULLABLE.toLowerCase() !== 'no';
    return {
        name: column.COLUMN_NAME,
        isId,
        position: column.ORDINAL_POSITION,
        defaultValue: column.COLUMN_DEFAULT,
        isNullable,
        isEditable: !isId,
        type: reference ? 'reference' : ensureType(type, columnType),
        referencedTable: reference ?? null,
        availableValues,
    };
};

function async getProperties(table) {
    const query = this.knex
        .from('information_schema.columns as col')
        .select('col.column_name', 'col.ordinal_position', 'col.column_default', 'col.is_nullable', 'col.data_type', 'col.column_type', 'col.column_key', 'col.extra', 'col.column_comment', 'key.referenced_table_name', 'key.referenced_column_name')
        .leftJoin('information_schema.key_column_usage as key', (c) => c
        .on('key.table_schema', 'col.table_schema')
        .on('key.table_name', 'col.table_name')
        .on('key.column_name', 'col.column_name')
        .on('key.referenced_table_schema', 'col.table_schema'))
        .where('col.table_schema', this.connectionOptions.database)
        .where('col.table_name', table);
    const columns = await query;
    return columns.map((col) => new Property(getColumnInfo(col)));
}
```

getPropertiesì—ì„œ kenxë¥¼ ì‚¬ìš©í•˜ëŠ”ë° ìˆì–´ columnsì˜ ê²°ê³¼ë¡œ mariadbì˜ ê²½ìš° ì†Œë­„ã„´ì í”„ë¡œí¼í‹°ë¥¼ ê°€ì§„ ì±„ ë°›ì•„ì˜¤ê²Œ ë©ë‹ˆë‹¤. ë°˜í™˜í•˜ëŠ” ë¶€ë¶„ì—ì„œ getColumnInfo í•¨ìˆ˜ë¥¼ ê±°ì¹˜ëŠ”ë° getColumnInfoí•¨ìˆ˜ë¥¼ ë³´ë©´ `column.DATA_TYPE.toLowerCase()` ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ì„œ sql ì—°ê²°ì´ ê³„ì† ë¨¹í†µì´ ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ë•Œë¬¸ì— sql í”ŒëŸ¬ê·¸ì¸ ìˆ˜ì •ì´ í•„ìš”í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

ì œê°€ ìˆ˜ì •í•œ ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```typescript showLineNumbers
// @adminjs/sql/lib/dialects/mysql.parser.js

export class MysqlParser extends BaseDatabaseParser {
  // ...

  async getProperties(table) {
    // ...
    // const columns = await query; // ì—¬ê¸°ë¥¼ ì•„ë˜ì²˜ëŸ¼ ë³€ê²½í•©ë‹ˆë‹¤.
    const columns = (await query).map((q) =>
      Object.assign(
        q,
        Object.fromEntries(
          Object.entries(q).map(([k, v]) => [k.toUpperCase(), v])
        )
      )
    );
    return columns.map((col) => new Property(getColumnInfo(col)));
  }
}
```

columnsëŠ” ê¸°ì¡´ì— ê°ì²´ ë°°ì—´ì„ ë°›ì•„ì˜¤ê²Œ ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ë°°ì—´ì„ mapìœ¼ë¡œ ëŒê³ , ëŒ€ë¬¸ì í”„ë¡œí¼í‹°ë¡œ ë³€ê²½í•˜ë©´ì„œ ê°’ì„ ë³µì‚¬í•˜ê³ , ì†Œë¬¸ì, ëŒ€ë¬¸ì í”„ë¡œí¼í‹°ë¥¼ ëª¨ë‘ ê°€ì§€ë„ë¡ ê°€ê³µí–ˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ sql í”ŒëŸ¬ê·¸ì¸ ì—°ê²° ì—ëŸ¬ ì´ìŠˆëŠ” í•´ê²°ì´ ë©ë‹ˆë‹¤.

### esm ë¬¸ì œ

í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ts-nodeë¥¼ ì„¤ì¹˜í•˜ê³  ì‚¬ìš©ì¤‘ì…ë‹ˆë‹¤. ts-nodeê´€ë ¨í•œ ì—ëŸ¬ê°€ ì´ˆê¸°ì— ë§ì´ ëœ¹ë‹ˆë‹¤. adminjsì˜ ë¬¸ì„œê°€ ë¶ˆì¹œì ˆí•˜ì§€ëŠ” ì•Šì§€ë§Œ ê²ªì—ˆë˜ ì´ìŠˆë“¤ì— ëŒ€í•œ íƒ­ì´ë‚˜ ì†”ë£¨ì…˜ì´ ì—†ì–´ì„œ ë§ì´ ì•„ì‰¬ì› ìŠµë‹ˆë‹¤. esmë¬¸ì œëŠ” ì•„ë˜ í•„ìê°€ ì„¤ì •í•œ tsconfigë¥¼ ì°¸ì¡°í•´ì£¼ì‹œë©´ ì™ ë§Œí•œ í™˜ê²½ì—ì„œëŠ” ëŒì•„ê°ˆ ê²ƒìœ¼ë¡œ ìƒê°ë©ë‹ˆë‹¤.

ì°¸ê³ ë¡œ package.jsonì—ì„œ ì‹¤í–‰ì€ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.

```json showLineNumbers
// package.json
{
  // ...
  "scripts": {
    "dev": "cross-env NODE_ENV=development nodemon --watch \"src/**\" --ext \"ts,json\" --ignore \"src/**/*.test.ts\" --exec \"ts-node src/index.ts\""
  }
  // ...
}
```

> ì•ì„œ ë³´ì—¬ë“œë ¸ë˜ `tsconfig.json`ì˜ `ts-node` ì„¤ì • ë¶€ë¶„ì€ í•¨ê»˜ ì‘ë™ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

### ts-node not found module ë¬¸ì œ

moduleì„ ì°¾ì§€ ëª»í•´ì„œ ì´ê²ƒì €ê²ƒ ë§ì´ ì‹œë„í•´ë´¤ëŠ”ë°ìš”. ê·¸ì¤‘ì—ì„œ ì œì¼ íš¨ê³¼ì ì´ì—ˆë˜ ê²ƒì€ import()ë¡œ ëª¨ë“ˆì„ ê°€ì ¸ì™€ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ì—ˆìŠµë‹ˆë‹¤.

```typescript showLineNumbers
import AdminJS from "adminjs"; // âŒ

async function start() {
  const AdminJS = await import("adminjs"); // âœ…
}
```

ì´ë ‡ê²Œ ë¶ˆëŸ¬ì™€ ì ìš©ì„ í•˜ë©´ ì•„ì£¼ ì‘ ì ìš©ì´ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë ‡ê²Œ ì„¤ì •í•˜ê³  ë‚˜ë©´ from ì˜† ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª…ì¹­ ë°‘ì— ë¹¨ê°„ì¤„ì´ ê·¸ì–´ì ¸ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ `not found module`ì´ ëœ° ìˆ˜ ìˆêµ¬ìš”.

ì´ë•ŒëŠ” `ts-ignore`ë¡œ ê²½ê³ ë¥¼ ì œê±°ì‹œí‚¤ë©´ í•´ë‹¹ ëª¨ë“ˆ ë¬¸ì œë¥¼ ë¬´ì‹œí•˜ê³  í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ëŠ¥ìƒ ë¬¸ì œëŠ” ì—†ì—ˆìŠµë‹ˆë‹¤.

```typescript showLineNumbers
async function start() {
  // @ts-ignore: unreachable code error
  const AdminJS = await import("adminjs");
}
```

ì•„ë˜ëŠ” @adminjs/fastify í”ŒëŸ¬ê·¸ì¸ì˜ ì´ˆê¸° ì„¤ì •ì— ì‚¬ìš©ë˜ëŠ” buildRouter í•¨ìˆ˜ì…ë‹ˆë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ë™ì‘í•˜ëŠ” ìˆœì„œë¥¼ ë³´ë©´ì„œ ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ë°›ì•„ì˜¤ëŠ”ì§€ ì•Œê¸° ìœ„í•´ ì ì‹œ ë³´ê² ìŠµë‹ˆë‹¤.

```typescript showLineNumbers
// @adminjs/fastify/lib/buildRouter.js

// ...

routes.forEach((route) => {
  // we have to change routes defined in AdminJS from {recordId} to :recordId
  const path = route.path.replace(/{/g, ":").replace(/}/g, "");
  const handler = async (request, reply) => {
    const controller = new route.Controller(
      { admin },
      request.session?.adminUser
    );
    const { params, query } = request;
    const method = request.method.toLowerCase();
    const body = request.body;
    console.log("check body", body); // ì—¬ê¸°
    const fields = fromPairs(
      Object.keys(body ?? {}).map((key) => [
        key,
        getFile(body[key]) ?? body[key].value,
      ])
    );
    const html = await controller[route.action](
      {
        ...request,
        params,
        query,
        payload: fields ?? {},
        method,
      },
      reply
    );
    if (route.contentType) {
      reply.type(route.contentType);
    } else if (typeof html === "string") {
      reply.type("text/html");
    }
    if (html) {
      return reply.send(html);
    }
  };
  if (route.method === "GET") {
    fastifyApp.get(`${admin.options.rootPath}${path}`, handler);
  }
  if (route.method === "POST") {
    fastifyApp.post(`${admin.options.rootPath}${path}`, handler);
  }
});

//...
```

![@adminjs/fastifyì—ì„œ ë°›ëŠ” body ë°ì´í„°](https://github.com/kkn1125/kkn1125.github.io/assets/113876485/27f36ec5-af68-496b-8b08-339461a32eed)

ìœ„ ì´ë¯¸ì§€ëŠ” ì½˜ì†”ë¡œ ì°ì€ ë¶€ë¶„ì˜ ë°ì´í„°ì¸ë°ìš”. `@adminjs/fastify` í”ŒëŸ¬ê·¸ì¸ì—ì„œ ì§ì ‘ multipartë¥¼ ì„¤ì •í•˜ê¸° ë•Œë¬¸ì— multipartError decorator ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œëŠ” multipartë¥¼ ì„¤ì •í•˜ê³  ì˜µì…˜ìœ¼ë¡œ addToBodyë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¶©ëŒì—ëŸ¬ê°€ ë°œìƒí•´ì„œ í”ŒëŸ¬ê·¸ì¸ê³¼ ë™ì¼í•˜ê²Œ attachFieldsToBodyë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

ë•Œë¬¸ì— ëª¨ë“  POST, PUT APIë¥¼ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬´í„±ëŒ€ê³  APIë¥¼ ëª¨ë‘ ê³ ì³¤ë‹¤ê°€ëŠ” ì´í›„ ìœ ì§€ë³´ìˆ˜ì— ë‚œí•­ì´ ìƒê¸°ê² ì§€ìš”. ë‹¤í–‰ìŠ¤ëŸ½ê²Œë„ fastifyëŠ” hookì„ ì œê³µí•˜ê¸° ë•Œë¬¸ì— ìš”ì²­ ì „, ì¤‘, í›„ ë“±ì˜ ì‹œì ì—ì„œ ê°€ë¡œì±„ì–´ ë°ì´í„°ë¥¼ ì œì–´í•˜ê±°ë‚˜ ìš”ì²­ì„ ëŒë¦¬ëŠ” ë“±ì˜ ì‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. buildRouterë¥¼ í†µí•´ ë“±ë¡ë˜ëŠ” ê²½ë¡œë¥¼ ì œì™¸í•œ ë¶€ë¶„ë§Œ body ë°ì´í„°ë¥¼ ê°€ê³µí•˜ê³  admin íŒ¨ë„ì˜ ê²½ë¡œë¡œ ë“¤ì–´ê°€ëŠ” ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê¸°ë§Œ í•´ì£¼ë©´ adminjsë¥¼ ì‚¬ìš©í•˜ë©´ì„œ apië¥¼ ê¸°ì¡´ ì½”ë“œ ìœ ì§€í•˜ë©´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript showLineNumbers
/* Hooks handler */
server.addHook("preValidation", async (req) => {
  // Some code
  if (!req.url.startsWith("/admin") && req.body) {
    const preParsingBody = Object.assign({}, Object.assign({}, req.body || {}));
    Object.assign(
      preParsingBody,
      Object.fromEntries(
        Object.entries(preParsingBody || {}).map(([k, v]) => [
          k,
          (v as any).value,
        ])
      )
    );
    const result = customParser(preParsingBody);
    Object.assign(req.body, result);
  }

  if (req.query) {
    const result = customParser(req.query);
    Object.assign(req.query, result);
  }
});
```

ìœ„ ì½”ë“œëŠ” í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œ preValidation hookì„ í†µí•´ ì–´ë“œë¯¼ê³¼ api ìš”ì²­ì„ ë¶„ê¸°í•´ì„œ ë°ì´í„°ë¥¼ ì œì–´í•˜ëŠ” ë¶€ë¶„ì„ ë°œì·Œí•œ ê²ƒ ì…ë‹ˆë‹¤. ì˜ˆì‹œë¡œ ë³´ì—¬ë“œë¦¬ëŠ” ê²ƒì´ë‹ˆ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

### AdminJSFastify buildRouter ë¬¸ì œ

buildRouterëŠ” ì„¤ì •í•  ë•Œ ì£¼ì˜í•  ì ì´ ë‘ ê°€ì§€ ìˆìŠµë‹ˆë‹¤. í•˜ë‚˜ëŠ” multipartë¥¼ ì‚¬ìš©í•œë‹¤ë©´ í•´ë‹¹ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ ì „(ì½”ë“œìƒ ìœ„ìª½ìœ¼ë¡œ) ë¨¼ì € í˜¸ì¶œ(ë“±ë¡)í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ìœ ëŠ” adminjs fastify ëª¨ë“ˆì—ì„œ buildRouter ë©”ì„œë“œê°€ ì´ˆê¸°í™”í•  ë‹¹ì‹œ multipartë¥¼ ë“±ë¡í•˜ê¸° ë•Œë¬¸ì— multipartError decoratorê°€ ì¶©ëŒë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì•ì„œ ë§í–ˆë“¯ì´ import()ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— registerë¡œ ë“±ë¡í•˜ëŠ” ë°©ë²•ì„ ì¶”ì²œí•©ë‹ˆë‹¤. ë¬¶ì—¬ìˆì–´ì„œ ë³´ê¸°ë„ ì‰½ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```typescript showLineNumbers
server.register(async (req, res, done) => {
  try {
    /* admin panel */
    // @ts-ignore: unreachable code error
    const AdminJSFastify = await import("@adminjs/fastify");
    // @ts-ignore: unreachable code error
    const { Adapter, Database, Resource } = await import("@adminjs/sql"); // or any other adapter
    // @ts-ignore: unreachable code error
    const { AdminJS } = await import("adminjs");
    const db = await new Adapter("mysql2", {
      /* ... db ì •ë³´ ... */
    }).init();

    AdminJS.registerAdapter({ Database, Resource });
    const admin = new AdminJS({
      resources: db.tables(),
      rootPath: "/admin",
    });

    await AdminJSFastify.buildRouter(admin, server);
    // console.log(AdminJSFastify.buildRouter);
  } catch (error) {
    console.log("error", error);
  }
  done();
});
```

## ë§ˆë¬´ë¦¬

ì´ë²ˆ í¬ìŠ¤íŒ…ì€ ë¹ ë¥´ê²Œ ê¸°ë¡ì„ ë‚¨ê¸°ê¸° ìœ„í•´ ë¶€ë¶„ë¶€ë¶„ ì ë‹¤ë³´ë‹ˆ ë‘ì„œê°€ ì—†ëŠ” ê²ƒ ê°™ì•„ ì´í›„ ë‹¤ë“¬ì„ ì˜ˆì •ì…ë‹ˆë‹¤.

Fastify API ì„œë²„ë¥¼ êµ¬ì¶•í•˜ê³  AdminJSë¥¼ ì—°ê²°í•´ì„œ ê´€ë¦¬ì íŒ¨ë„ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í”„ë¡œì íŠ¸ í™˜ê²½ì„ ì œì‘í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì •ë§ ë¬¸ì„œí™”ê°€ ì¤‘ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ë˜ í•œ ë²ˆ ëŠë¼ê²Œ ë˜ëŠ” ì‘ì—…ì´ì—ˆìŠµë‹ˆë‹¤. AdminJS ë¬¸ì„œê°€ ì˜ ë˜ì–´ ìˆê¸´ í•˜ì§€ë§Œ, ì¢€ ë¶ˆì¹œì ˆí•˜ë‹¤ê³  ëŠë¼ëŠ” ë¶€ë¶„ì´ í•˜ë‚˜ ìˆìŠµë‹ˆë‹¤. Adapterì—ì„œ ì–´ë–¤ ì¢…ë¥˜ì˜ db íƒ€ì…ì´ ìˆëŠ”ì§€ ë‚˜ì™€ ìˆìœ¼ë©´ ì¢‹ê² ì§€ë§Œ ë”°ë¡œ ì–¸ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤. ê¶ê¸ˆí•´ì„œ ì°¾ì•„ë³´ë‹ˆ ë¬¸ì„œì—ëŠ” ì—†ê³ , stackoverflowì— ìˆë”ë¼êµ¬ìš” ğŸ˜…

ì°¸ê³ ë¡œ íƒ€ì…ì€ mysql, mysql2, postgresê°€ ìˆìŠµë‹ˆë‹¤. @adminjs/sql í”ŒëŸ¬ê·¸ì¸ì„ ì´ìš©í•˜ê³ , ì´ í”ŒëŸ¬ê·¸ì¸ì´ knexë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë‹ˆ ê·¸ëŸ° ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ adapter db ì—°ê²° ì‹œ postgresëŠ” urlí˜•ì‹ìœ¼ë¡œ ì ì–´ì•¼í•˜ê³ , mysql, mysql2ëŠ” ì˜¤ë¸Œì íŠ¸ë¡œ ì ì–´ì•¼í•©ë‹ˆë‹¤. ì•ˆê·¸ëŸ¬ë©´ ì—°ê²°ì¡°ì°¨ ì•ˆ ë©ë‹ˆë‹¤.

ì´ì „ê¹Œì§€ë§Œ í•´ë„ ìˆëŠ” ëª¨ë“ˆì´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í”„ë¡œì íŠ¸ì— ë§ê²Œ ì»¤ìŠ¤í…€ì´ í•„ìš”í•˜ê³ , í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì• ìš©í•œë‹¤ë©´ í•„ìš”ì— ë”°ë¼ ê¹ƒí—ˆë¸Œì— ì´ìŠˆë¥¼ ë§Œë“¤ì–´ ì œì•ˆí•˜ê±°ë‚˜ í•˜ëŠ” í–‰ìœ„ ë˜í•œ í•„ìš”í•˜ë‹¤ê³  ëŠê¼ˆìŠµë‹ˆë‹¤. ëª¨ë“ˆì„ ì‚¬ìš©í•˜ëŠ”ë° ìˆì–´ì„œ ì»¤ë®¤ë‹ˆí‹°ì— ë‹¹ë‹¹í•˜ê²Œ ë²„ê·¸ë‚˜ ì´ìŠˆë¥¼ ë˜ì§€ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°ì´ ë“­ë‹ˆë‹¤.

ì—¬í•˜íŠ¼ ê°™ì€ ìƒí™©ì— ë†“ì¸ ë¶„ë“¤ì´ ìˆë‹¤ë©´ ì¡°ê¸ˆì´ë‚˜ë§ˆ ë„ì›€ì´ ë˜ì‹œê¸°ë¥¼ ğŸ˜Š
